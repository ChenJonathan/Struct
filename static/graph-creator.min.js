document.onload=function(e,t,n,o){"use strict";var r={defaultTitle:"random variable"},s={appendElSpec:"#graph"},a=function(o,r,s){var a=this;a.idct=0,a.nodes=r||[],a.edges=s||[],a.state={selectedNode:null,selectedEdge:null,mouseDownNode:null,mouseDownLink:null,justDragged:!1,justScaleTransGraph:!1,lastKeyDown:-1,shiftNodeDrag:!1,selectedText:null};var i=o.append("svg:defs");i.append("svg:marker").attr("id","end-arrow").attr("viewBox","0 -5 10 10").attr("refX","32").attr("markerWidth",3.5).attr("markerHeight",3.5).attr("orient","auto").append("svg:path").attr("d","M0,-5L10,0L0,5"),i.append("svg:marker").attr("id","mark-end-arrow").attr("viewBox","0 -5 10 10").attr("refX",7).attr("markerWidth",3.5).attr("markerHeight",3.5).attr("orient","auto").append("svg:path").attr("d","M0,-5L10,0L0,5"),a.svg=o,a.svgG=o.append("g").classed(a.consts.graphClass,!0);var d=a.svgG;a.dragLine=d.append("svg:path").attr("class","link dragline hidden").attr("d","M0,0L0,0").style("marker-end","url(#mark-end-arrow)"),a.paths=d.append("g").selectAll("g"),a.circles=d.append("g").selectAll("g"),a.drag=e.behavior.drag().origin(function(e){return{x:e.x,y:e.y}}).on("drag",function(e){a.state.justDragged=!0,a.dragmove.call(a,e)}).on("dragend",function(){}),e.select(window).on("keydown",function(){a.svgKeyDown.call(a)}).on("keyup",function(){a.svgKeyUp.call(a)}),o.on("mousedown",function(e){a.svgMouseDown.call(a,e)}),o.on("mouseup",function(e){a.svgMouseUp.call(a,e)});var l=e.behavior.zoom().on("zoom",function(){return e.event.sourceEvent.shiftKey?!1:(a.zoomed.call(a),!0)}).on("zoomstart",function(){var t=e.select("#"+a.consts.activeEditId).node();t&&t.blur(),e.event.sourceEvent.shiftKey||e.select("body").style("cursor","move")}).on("zoomend",function(){e.select("body").style("cursor","auto")});o.call(l).on("dblclick.zoom",null),window.onresize=function(){a.updateWindow(o)},e.select("#download-input").on("click",function(){var e=[];a.edges.forEach(function(t,n){e.push({source:t.source.id,target:t.target.id})});var o=new n([window.JSON.stringify({nodes:a.nodes,edges:e})],{type:"text/plain;charset=utf-8"});t(o,"mydag.json")}),e.select("#upload-input").on("click",function(){document.getElementById("hidden-file-upload").click()}),e.select("#hidden-file-upload").on("change",function(){if(window.File&&window.FileReader&&window.FileList&&window.Blob){var e=this.files[0],t=new window.FileReader;t.onload=function(){var e=t.result;try{var n=JSON.parse(e);a.deleteGraph(!0),a.nodes=n.nodes,a.setIdCt(n.nodes.length+1);var o=n.edges;o.forEach(function(e,t){o[t]={source:a.nodes.filter(function(t){return t.id==e.source})[0],target:a.nodes.filter(function(t){return t.id==e.target})[0]}}),a.edges=o,a.updateGraph()}catch(r){return void window.alert("Error parsing uploaded file\nerror message: "+r.message)}},t.readAsText(e)}else alert("Your browser won't let you save this graph -- try upgrading your browser to IE 10+ or Chrome or Firefox.")}),e.select("#delete-graph").on("click",function(){a.deleteGraph(!1)})};a.prototype.setIdCt=function(e){this.idct=e},a.prototype.consts={selectedClass:"selected",connectClass:"connect-node",circleGClass:"conceptG",graphClass:"graph",activeEditId:"active-editing",BACKSPACE_KEY:8,DELETE_KEY:46,ENTER_KEY:13,nodeRadius:50},a.prototype.dragmove=function(t){var n=this;n.state.shiftNodeDrag?n.dragLine.attr("d","M"+t.x+","+t.y+"L"+e.mouse(n.svgG.node())[0]+","+e.mouse(this.svgG.node())[1]):(t.x+=e.event.dx,t.y+=e.event.dy,n.updateGraph())},a.prototype.deleteGraph=function(e){var t=this,n=!0;e||(n=window.confirm("Press OK to delete this graph")),n&&(t.nodes=[],t.edges=[],t.updateGraph())},a.prototype.selectElementContents=function(e){var t=document.createRange();t.selectNodeContents(e);var n=window.getSelection();n.removeAllRanges(),n.addRange(t)},a.prototype.insertTitleLinebreaks=function(e,t){for(var n=t.split(/\s+/g),o=n.length,r=e.append("text").attr("text-anchor","middle").attr("dy","-"+7.5*(o-1)),s=0;s<n.length;s++){var a=r.append("tspan").text(n[s]);s>0&&a.attr("x",0).attr("dy","15")}},a.prototype.spliceLinksForNode=function(e){var t=this,n=t.edges.filter(function(t){return t.source===e||t.target===e});n.map(function(e){t.edges.splice(t.edges.indexOf(e),1)})},a.prototype.replaceSelectEdge=function(e,t){var n=this;e.classed(n.consts.selectedClass,!0),n.state.selectedEdge&&n.removeSelectFromEdge(),n.state.selectedEdge=t},a.prototype.replaceSelectNode=function(e,t){var n=this;e.classed(this.consts.selectedClass,!0),n.state.selectedNode&&n.removeSelectFromNode(),n.state.selectedNode=t},a.prototype.removeSelectFromNode=function(){var e=this;e.circles.filter(function(t){return t.id===e.state.selectedNode.id}).classed(e.consts.selectedClass,!1),e.state.selectedNode=null},a.prototype.removeSelectFromEdge=function(){var e=this;e.paths.filter(function(t){return t===e.state.selectedEdge}).classed(e.consts.selectedClass,!1),e.state.selectedEdge=null},a.prototype.pathMouseDown=function(t,n){var o=this,r=o.state;e.event.stopPropagation(),r.mouseDownLink=n,r.selectedNode&&o.removeSelectFromNode();var s=r.selectedEdge;s&&s===n?o.removeSelectFromEdge():o.replaceSelectEdge(t,n)},a.prototype.circleMouseDown=function(t,n){var o=this,r=o.state;return e.event.stopPropagation(),r.mouseDownNode=n,e.event.shiftKey?(r.shiftNodeDrag=e.event.shiftKey,void o.dragLine.classed("hidden",!1).attr("d","M"+n.x+","+n.y+"L"+n.x+","+n.y)):void 0},a.prototype.changeTextOfNode=function(t,n){var o=this,r=o.consts,s=t.node();t.selectAll("text").remove();var a=s.getBoundingClientRect(),i=a.width/r.nodeRadius,d=5*i,l=i>1?.71*a.width:1.42*r.nodeRadius,c=o.svg.selectAll("foreignObject").data([n]).enter().append("foreignObject").attr("x",a.left+d).attr("y",a.top+d).attr("height",2*l).attr("width",l).append("xhtml:p").attr("id",r.activeEditId).attr("contentEditable","true").text(n.title).on("mousedown",function(t){e.event.stopPropagation()}).on("keydown",function(t){e.event.stopPropagation(),e.event.keyCode!=r.ENTER_KEY||e.event.shiftKey||this.blur()}).on("blur",function(n){n.title=this.textContent,o.insertTitleLinebreaks(t,n.title),e.select(this.parentElement).remove()});return c},a.prototype.circleMouseUp=function(t,n){var o=this,r=o.state,s=o.consts;r.shiftNodeDrag=!1,t.classed(s.connectClass,!1);var a=r.mouseDownNode;if(a){if(o.dragLine.classed("hidden",!0),a!==n){var i={source:a,target:n},d=o.paths.filter(function(e){return e.source===i.target&&e.target===i.source&&o.edges.splice(o.edges.indexOf(e),1),e.source===i.source&&e.target===i.target});d[0].length||(o.edges.push(i),o.updateGraph())}else if(r.justDragged)r.justDragged=!1;else if(e.event.shiftKey){var l=o.changeTextOfNode(t,n),c=l.node();o.selectElementContents(c),c.focus()}else{r.selectedEdge&&o.removeSelectFromEdge();var u=r.selectedNode;u&&u.id===n.id?o.removeSelectFromNode():o.replaceSelectNode(t,n)}r.mouseDownNode=null}},a.prototype.svgMouseDown=function(){this.state.graphMouseDown=!0},a.prototype.svgMouseUp=function(){var t=this,n=t.state;if(n.justScaleTransGraph)n.justScaleTransGraph=!1;else if(n.graphMouseDown&&e.event.shiftKey){var o=e.mouse(t.svgG.node()),s={id:t.idct++,title:r.defaultTitle,x:o[0],y:o[1]};t.nodes.push(s),t.updateGraph();var a=t.changeTextOfNode(t.circles.filter(function(e){return e.id===s.id}),s),i=a.node();t.selectElementContents(i),i.focus()}else n.shiftNodeDrag&&(n.shiftNodeDrag=!1,t.dragLine.classed("hidden",!0));n.graphMouseDown=!1},a.prototype.svgKeyDown=function(){var t=this,n=t.state,o=t.consts;if(-1===n.lastKeyDown){n.lastKeyDown=e.event.keyCode;var r=n.selectedNode,s=n.selectedEdge;switch(e.event.keyCode){case o.BACKSPACE_KEY:case o.DELETE_KEY:e.event.preventDefault(),r?(t.nodes.splice(t.nodes.indexOf(r),1),t.spliceLinksForNode(r),n.selectedNode=null,t.updateGraph()):s&&(t.edges.splice(t.edges.indexOf(s),1),n.selectedEdge=null,t.updateGraph())}}},a.prototype.svgKeyUp=function(){this.state.lastKeyDown=-1},a.prototype.updateGraph=function(){var t=this,n=t.consts,o=t.state;t.paths=t.paths.data(t.edges,function(e){return String(e.source.id)+"+"+String(e.target.id)});var r=t.paths;r.style("marker-end","url(#end-arrow)").classed(n.selectedClass,function(e){return e===o.selectedEdge}).attr("d",function(e){return"M"+e.source.x+","+e.source.y+"L"+e.target.x+","+e.target.y}),r.enter().append("path").style("marker-end","url(#end-arrow)").classed("link",!0).attr("d",function(e){return"M"+e.source.x+","+e.source.y+"L"+e.target.x+","+e.target.y}).on("mousedown",function(n){t.pathMouseDown.call(t,e.select(this),n)}).on("mouseup",function(e){o.mouseDownLink=null}),r.exit().remove(),t.circles=t.circles.data(t.nodes,function(e){return console.log("ID: "+e.id),e.id}),t.circles.attr("transform",function(e){return"translate("+e.x+","+e.y+")"});var s=t.circles.enter().append("g");s.classed(n.circleGClass,!0).attr("transform",function(e){return"translate("+e.x+","+e.y+")"}).on("mouseover",function(t){o.shiftNodeDrag&&e.select(this).classed(n.connectClass,!0)}).on("mouseout",function(t){e.select(this).classed(n.connectClass,!1)}).on("mousedown",function(n){t.circleMouseDown.call(t,e.select(this),n)}).on("mouseup",function(n){t.circleMouseUp.call(t,e.select(this),n)}).call(t.drag),s.append("circle").attr("r",String(n.nodeRadius)).attr("fill","steelblue"),s.each(function(n){t.insertTitleLinebreaks(e.select(this),n.title)}),t.circles.exit().remove()},a.prototype.zoomed=function(){this.state.justScaleTransGraph=!0,e.select("."+this.consts.graphClass).attr("transform","translate("+e.event.translate+") scale("+e.event.scale+")")},a.prototype.updateWindow=function(e){var t=document.documentElement,n=document.getElementsByTagName("body")[0],o=window.innerWidth||t.clientWidth||n.clientWidth,r=window.innerHeight||t.clientHeight||n.clientHeight;e.attr("width",o).attr("height",r)},window.onbeforeunload=function(){return"Make sure to save your graph locally before leaving :-)"};var i=document.documentElement,d=document.getElementsByTagName("body")[0],l=window.innerWidth||i.clientWidth||d.clientWidth,c=window.innerHeight||i.clientHeight||d.clientHeight,f=[],g=[],h=e.select(s.appendElSpec).append("svg").attr("width",l).attr("height",c),v=new a(h,f,g);v.setIdCt(2),v.updateGraph(),setInterval(function(){console.log(thisGraph.circles)},3e3),e.selectAll(".conceptG").selectAll("circle").on("click",function(){console.log("Click registered properly")})}(window.d3,window.saveAs,window.Blob);